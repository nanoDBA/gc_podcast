name: Update Podcast Feed

on:
  schedule:
    # General Conference is the first full weekend of April and October
    # Audio release pattern: full sessions same day, individual talks within ~7 days
    #
    # Schedule tiers:
    # 1. Conference weekend (1st-7th): Check 3x daily to catch drops quickly
    # 2. Following week (8th-14th): Check daily for remaining individual talks
    # 3. Rest of year: Monthly maintenance check

    # Conference weekend - 3x daily (morning, afternoon, evening MDT)
    - cron: '0 14 1-7 4,10 *'    # 8 AM MDT
    - cron: '0 18 1-7 4,10 *'    # 12 PM MDT
    - cron: '0 2 2-8 4,10 *'     # 8 PM MDT (next UTC day for 2nd-8th)

    # Following week - daily check
    - cron: '0 18 8-14 4,10 *'   # 12 PM MDT, Apr/Oct 8-14

    # Monthly maintenance (rest of year)
    - cron: '0 12 15 1-3,5-9,11-12 *'  # 15th of non-conference months

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_scrape:
        description: 'Force re-scrape all conferences'
        required: false
        default: 'false'
        type: boolean
      start_year:
        description: 'Start year for scraping'
        required: false
        default: ''
        type: string
      languages:
        description: 'Languages to scrape (eng, spa, por, or all)'
        required: false
        default: 'all'
        type: string

jobs:
  update-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: gc-cache-${{ github.run_id }}
          restore-keys: |
            gc-cache-

      - name: Scrape conferences (English)
        run: |
          if [ "${{ inputs.force_scrape }}" = "true" ]; then
            npx tsx src/scrape-all.ts --recent --force -l eng
          elif [ -n "${{ inputs.start_year }}" ]; then
            npx tsx src/scrape-all.ts --start ${{ inputs.start_year }} --force -l eng
          else
            npx tsx src/scrape-all.ts --recent -l eng
          fi

      - name: Scrape conferences (Spanish)
        if: ${{ inputs.languages == 'all' || inputs.languages == 'spa' || inputs.languages == '' }}
        run: npx tsx src/scrape-all.ts --recent -l spa
        continue-on-error: true

      - name: Scrape conferences (Portuguese)
        if: ${{ inputs.languages == 'all' || inputs.languages == 'por' || inputs.languages == '' }}
        run: npx tsx src/scrape-all.ts --recent -l por
        continue-on-error: true

      - name: Generate RSS feeds (all languages)
        run: |
          mkdir -p docs
          npx tsx src/generate-feed.ts \
            --output ./output \
            --feed ./docs/audio.xml \
            --all-languages \
            --base-url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      - name: Check for changes
        id: changes
        run: |
          git add output/ docs/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update podcast feed [automated]

          $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push

  deploy:
    needs: update-feed
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Pull latest changes
        run: git pull

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
